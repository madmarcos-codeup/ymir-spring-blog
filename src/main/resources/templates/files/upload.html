<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <header th:insert="partials :: head"></header>
    <title>Upload File</title>
</head>
<body>
<nav th:replace="partials :: navbar">
</nav>

<div class="container-fluid">
  <form class="mb-3" th:action="@{/files/create}" th:method="post" th:object="${myFile}">
      <input type="hidden" id="id" th:field="*{id}">
      <input type="hidden" class="form-control" id="fileName" th:field="*{fileName}">
      <div class="mb-3">
          <label for="description" class="form-label">Description</label>

          <textarea class="form-control" id="description" th:field="*{description}" rows="3" placeholder="Description goes here">put stuff here</textarea>
      </div>

      <input id="cloudKey" type="hidden" th:field="*{cloudKey}">
      <input id="fileType" type="hidden" th:field="*{fileType}">

      <input disabled id="cloudURL" type="hidden">

      <div class="mb-3">
          <label for="fileInput" class="form-label">Choose a file:</label>

          <input disabled type="file" class="form-control" id="fileInput" name="fileInput" accept="image/png, image/jpeg, image/gif">

          <div class="mt-1 ms-3 me-3">
            <label for="uploadProgress" class="form-label">Upload progress:</label>
              <div id="uploadProgress" class="progress w-50">
                  <div class="progress-bar" id="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            <button disabled type="button" id="cancelUpload" class="btn btn-info" name="cancelUpload">Cancel</button>
          </div>
      </div>

      <button disabled type="submit" id="submitButton" class="btn btn-primary">Save File</button>
  </form>

    <footer th:replace="partials :: footer">
    </footer>

</div>

<!--just say "no" to aws-sdk v3-->
<!--<script src="/js/bundle.js"></script>-->
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1357.0.min.js"></script>

<script>
    let xhr = undefined;
    document.addEventListener("DOMContentLoaded", function() {
        resetGUI();

        document.querySelector("#cancelUpload").addEventListener("click", function() {
            xhr.abort();
            resetGUI();
        });

        document.querySelector("#fileInput").addEventListener("change", async function (event) {
            const mimeType = event.target.files[0].type;

            const presignedURL = await getPresignedURL(mimeType);
            console.log(presignedURL)
            //can't do anything until we get a presigned url
            document.querySelector("#cloudURL").value = presignedURL.url;
            document.querySelector("#cloudKey").value = presignedURL.key;
            document.querySelector("#fileType").value = mimeType;
            const tokens = document.querySelector("#fileInput").value.split("\\");
            document.querySelector("#fileName").value = tokens[tokens.length - 1];

            document.querySelector("#cancelUpload").disabled = false;
            // cannot change a file until file finishes uploading or cancel is clicked
            document.querySelector("#fileInput").disabled = true;

            uploadFile(presignedURL.url, event.target.files[0], mimeType);
        })
    });

    function resetGUI() {
        document.querySelector("#submitButton").disabled = true;
        document.querySelector("#cancelUpload").disabled = true;
        const fileInput = document.querySelector("#fileInput");
        fileInput.disabled = false;
        fileInput.value = "";
        document.querySelector("#cloudURL").value = "";
        document.querySelector("#cloudKey").value = "";
        document.querySelector("#fileType").value = "";

        // clear progress bar
        const progressBar = document.querySelector("#progress-bar");
        progressBar.innerHTML = "";
        progressBar.setAttribute("aria-valuenow", "0");
    }

    async function uploadFile(url, file, mimeType) {
        // must use xmlhttprequest instead of fetch for upload progress tracking
        // https://javascript.info/fetch-progress
        xhr = new XMLHttpRequest();
        xhr.open('PUT', url);
        xhr.setRequestHeader('Content-Type', mimeType);
        xhr.onloadend = function() {
            console.log("response code is " + xhr.status);
            document.querySelector("#submitButton").disabled = false;
        }
        xhr.upload.onprogress = function(event) {
            // document.querySelector("#uploadProgress").value = `Uploaded ${event.loaded} of ${event.total}`;
            const amt = Math.round(event.loaded / event.total * 100);
            document.querySelector("#progress-bar").innerHTML = amt + "%";
            document.querySelector("#progress-bar").style.width = amt + "%";
        };
        xhr.send(file);
    }

    function getPresignedURL(mimeType) {
        const url = `/files/presign?mimeType=` + mimeType;
        return fetch(url)
            .then(function(response) {
                return response.json();
        }).then(function(jsonResponse) {
            return jsonResponse;
        });
    }

</script>
</body>
</html>